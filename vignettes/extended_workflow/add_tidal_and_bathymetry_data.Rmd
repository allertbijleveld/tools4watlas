---
title: "Add tidal data"
author: "Johannes Krietsch"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Add tidal data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  out.width = "100%",
  fig.width = 8.89, fig.height = 5,
  dpi = 300,
  dev = "ragg_png"
)
```

 This vignette shows how to add tidal data to WATLAS data.

```{r}
library(tools4watlas)
library(data.table)
library(ggplot2)

# Path to csv with raw data
data_path <- system.file(
  "extdata", "watlas_data_aggregated.csv",
  package = "tools4watlas"
)

# Load data
data <- fread(data_path, yaml = TRUE)

```

## Add tidal data 

```{r}
# path to tide data
tides_path <- system.file(
  "extdata", "example_2023_tide_data_UTC.csv",
  package = "tools4watlas"
)
tide_data_highres_path <- system.file(
  "extdata", "example_2023_tide_data_highres_UTC.csv",
  package = "tools4watlas"
)

# load tide data
tides <- data.table::fread(tides_path)
tide_data_highres <- data.table::fread(tide_data_highres_path)

# add tide data to movement data
data <- atl_add_tidal_data(
  data = data,
  tide_data = tides,
  tide_data_highres = tide_data_highres,
  waterdata_resolution = "10 minute",
  offset = 30
)

# Show first 5 rows (subset of columns to show additional ones)
head(data[, .(posID, tag, datetime, tideID, tidaltime, time2lowtide,
              waterlevel)]) |>
  knitr::kable(digits = 2)
```

### Select specific times within the tide cycle  

For specific analyses, the cleaned data can be selected. To select localizations when mudlfats are available for foraging, we can for example select a low tide period from -2.5 hours to +2.5 hours around low tide [(Bijleveld et al. 2016)](https://royalsocietypublishing.org/doi/10.1098/rspb.2015.1557): 

```{r}
# check tide ID
data[, tideID] |> unique()

# Select the low tide period for a particular tide as specified by tideID
data_subset <- atl_filter_covariates(
  data = data,
  filters = c(
    "tideID %in% c(2023513, 2023514)",
    "between(time2lowtide, -2.5 * 60, 2.5 * 60)"
  )
)
```

### Save as example data for `tools4watlas`.
	
```{r, eval=FALSE}
# reassign so data is data
data_example <- data
save(data_example, file = "../data/watlas_data_example.rda")
```	


A short example of how to add bathymetry data to WATLAS data. 

Bathymetry data can be found in the "Birds, fish 'n chips" SharePoint folder: `Documents/data/GIS/rasters/`. To run the script set the file path (`wd`) to the local copy of the folder on your computer. The data can also be downloaded from the [Waddenregister](https://datahuiswadden.openearth.nl/geonetwork/srv/eng/catalog.search#/metadata/JkrvJXasRSGAWU1mJLHUzg).

### Load packages and data

```{r}
# Packages
library(data.table)
library(tools4watlas)
library(terra)
library(ggplot2)
library(viridis)
library(scales)

# Load bathymetry data
wd <- "C:/Users/jkrietsch/OneDrive - NIOZ/Documents/MAP_DATA/"
bat <- rast(paste0(wd, "bathymetry/2024/bodemhoogte_20mtr_UTM31_int.tif"))

# Load example data
data <- data_example
```

## Add bathymetry data to WATLAS data

Extract bathymetry data for each location and coarsely classify time in the tide cycle. 

```{r}
# add bathymetry data
data <- atl_add_raster_data(
  data, raster_data = bat, new_name = "bathymetry", change_unit = 100 # m to cm
)

# classify in low, changing and high tide
data[, tide := fcase(
  waterlevel <= -50, "low tide",
  waterlevel >= -50 & waterlevel <= 50, "changing",
  waterlevel >= 50, "high tide"
)]

# factor with levels
data[, tide := factor(tide, levels = c("low tide", "changing", "high tide"))]
```

## Plot data at low tide

Subset data at low tide and plot on bathymetry base map.

```{r, fig.cap = "Movement tracks colored with bathymetry data"}
# subset low tide data
data_subset <- data[tide == "low tide" | tide == "changing"]

# create base map with bathymetry data
bm <- atl_create_bm(
  data_subset,
  buffer = 1000, raster_data = bat, option = "batymetry"
)

# plot data
bm +
  geom_path(
    data = data_subset, aes(x, y, group = tag, colour = bathymetry),
    alpha = 0.1, show.legend = FALSE
  ) +
  geom_point(
    data = data_subset, aes(x, y, color = bathymetry), size = 1,
    alpha = 0.7, show.legend = TRUE
  ) +
  guides(colour = guide_colourbar(position = "inside"), fill = "none") +
  scale_color_viridis(
    direction = 1, option = "inferno", name = "Bathymetry\n(cmNHM)",
    limits = c(-200, 200), oob = scales::squish
  ) +
  theme(
    legend.position.inside = c(0.07, 0.2),
    legend.background = element_rect(fill = NA)
  )
```





