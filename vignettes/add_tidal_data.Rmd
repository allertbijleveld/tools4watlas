---
title: "Add tidal data"
author: "Johannes Krietsch"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Add tidal data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  out.width = "100%",
  fig.width = 8.89, fig.height = 5,
  dpi = 300,
  dev = "ragg_png"
)
```

 This vignette shows how to add tidal data to WATLAS data.

```{r}
library(tools4watlas)
library(data.table)
library(ggplot2)

# Path to csv with raw data
data_path <- system.file(
  "extdata", "watlas_data_aggregated.csv",
  package = "tools4watlas"
)

# Load data
data <- fread(data_path, yaml = TRUE)

```

## Add tidal data 

```{r}
# setorder
setorder(data, tag, time)

# path to tide data
tides_path <- system.file(
  "extdata", "example_2023_tide_data_UTC.csv",
  package = "tools4watlas"
)
tide_data_highres_path <- system.file(
  "extdata", "example_2023_tide_data_highres_UTC.csv",
  package = "tools4watlas"
)

# load tide data
tides <- data.table::fread(tides_path)
tide_data_highres <- data.table::fread(tide_data_highres_path)

# add tide data to movement data
data <- atl_add_tidal_data(
  data = data,
  tide_data = tides,
  tide_data_highres = tide_data_highres,
  waterdata_resolution = "10 minute",
  offset = 30
)

# Show first 5 rows (subset of columns to show additional ones)
head(data[, .(posID, tag, datetime, tideID, tidaltime, time2lowtide,
              waterlevel)]) |>
  knitr::kable(digits = 2)
```

### Select specific times within the tide cycle  

For specific analyses, the cleaned data can be selected. To select localizations when mudlfats are available for foraging, we can for example select a low tide period from -2.5 hours to +2.5 hours around low tide [(Bijleveld et al. 2016)](https://royalsocietypublishing.org/doi/10.1098/rspb.2015.1557): 

```{r}
# check tide ID
data[, tideID] |> unique()

# Select the low tide period for a particular tide as specified by tideID
data_subset <- atl_filter_covariates(
  data = data,
  filters = c(
    "tideID == 2023530",
    "between(time2lowtide, -2.5 * 60, 2.5 * 60)"
  )
)
```

### Save as example data for `tools4watlas`.
	
```{r, eval=FALSE}
# reassign so data is data
data_example <- data_subset
save(data_example, file = "../data/watlas_data_example.rda")
```	
	
			
