---
title: "Plot data"
author: "Johannes Krietsch"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plot data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  out.width = "100%",
  fig.width = 8.89, fig.height = 5,
  dpi = 300,
  dev = "ragg_png",
  message = FALSE
)
```

#### Load packages and data

This vignette shows different ways on how to plot WATLAS data. Each chunk of code only requires this chunk with loading the data to be run before and is otherwise independent. 

```{r}
# Packages
library(tools4watlas)
library(data.table)
library(ggplot2)
library(viridis)
library(RColorBrewer)
```

## Using `ggplot2` and a basemap layer

We can create simple base maps of the study area by using the function `atl_create_bm()`. This function uses a data.table with x- and y-coordinates to check the required bounding box (which can be extended with a buffer in meters) and spatial features (polygons) of land, lakes, mudflats and rivers. Without adding costmized data, it will default to the data provided in the package. By changing `asp` the desired aspect ratio can be chosen (default is "16:9"). If no data are provided the function creates a map around Griend with a specified buffer. 

#### Map with points and tracks of one individual

```{r, fig.cap = "Points and tracks on a simple basemap", fig.align = "center"}
# Load example data
data <- data_example

# Subset bar-tailed godwit
data_subset <- data[species == "bar-tailed godwit"]

# Create base map
bm <- atl_create_bm(data_subset, buffer = 800)

# Plot points and tracks
bm +
  geom_path(
    data = data_subset, aes(x, y, colour = tag),
    alpha = 0.1, show.legend = FALSE
  ) +
  geom_point(
    data = data_subset, aes(x, y, colour = tag),
    size = 0.5, show.legend = FALSE
  ) +
  scale_color_brewer(palette = "Dark2") # for up to 8 categories
```

#### Map with points and tracks of multiple species

```{r, fig.cap = "Points and tracks of multiple species on a basemap" , fig.align = "center"}

# Create base map
bm <- atl_create_bm(data, buffer = 800)

# Plot points and tracks
bm +
  geom_path(
    data = data, aes(x, y, colour = species),
    alpha = 0.5, show.legend = FALSE
  ) +
  geom_point(
    data = data, aes(x, y, color = species),
    size = 1, show.legend = TRUE
  ) +
  scale_color_manual(
    values = atl_spec_cols(),
    labels = atl_spec_labs("multiline"),
    name = ""
  ) +
  guides(colour = guide_legend(
    nrow = 1, override.aes = list(size = 7, pch = 16, alpha = 1)
  )) +
  theme(
    legend.position = "top",
    legend.justification = "center",
    legend.key = element_blank(),
    legend.background = element_rect(fill = "transparent")
  )
```

#### Heatmap of all positions

```{r, fig.cap = "Heatmap of all positions", fig.align = "center"}
library(scales)

# Round data to 200 m grid cells
data_heatmap <- copy(data)
data_heatmap[, c("x_round", "y_round") := list(
  plyr::round_any(x, 200),
  plyr::round_any(y, 200)
)]
data_heatmap <- data_heatmap[, .N, by = c("x_round", "y_round")]

# Plot heatmap
bm +
  geom_tile(
    data = data_heatmap, aes(x_round, y_round, fill = N),
    linewidth = 0.1, show.legend = TRUE
  ) +
  scale_fill_viridis(
    option = "A", discrete = FALSE, trans = "log10", name = "N positions",
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
    direction = -1
  )
```
