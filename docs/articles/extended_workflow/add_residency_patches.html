<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Add residency patches • tools4watlas</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../../favicon.ico">
<link rel="manifest" href="../../site.webmanifest">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Add residency patches">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">tools4watlas</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Basic workflow (Vignettes)</h6></li>
    <li><a class="dropdown-item" href="../../articles/load_and_check_data.html">Load and check data</a></li>
    <li><a class="dropdown-item" href="../../articles/filter_data.html">Filter data</a></li>
    <li><a class="dropdown-item" href="../../articles/smooth_and_thin_data.html">Smooth and thin data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extended workflow</h6></li>
    <li><a class="dropdown-item" href="../../articles/extended_workflow/add_tidal_and_bathymetry_data.html">Add tidal and bathymetry data</a></li>
    <li><a class="dropdown-item" href="../../articles/extended_workflow/add_residency_patches.html">Add residency patches</a></li>
    <li><a class="dropdown-item" href="../../articles/extended_workflow/add_SIBES_data.html">Add SIBES data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Visualization tutorials</h6></li>
    <li><a class="dropdown-item" href="../../articles/visualization_tutorials/create_basemap.html">Create a basemap</a></li>
    <li><a class="dropdown-item" href="../../articles/visualization_tutorials/plot_data.html">Plot data</a></li>
    <li><a class="dropdown-item" href="../../articles/visualization_tutorials/plot_data_in_loop.html">Plot data in loop</a></li>
    <li><a class="dropdown-item" href="../../articles/visualization_tutorials/plot_data_faster.html">Plot data faster</a></li>
    <li><a class="dropdown-item" href="../../articles/visualization_tutorials/plot_data_interactively.html">Plot data interactively</a></li>
    <li><a class="dropdown-item" href="../../articles/visualization_tutorials/animate_data.html">Animate data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Package development</h6></li>
    <li><a class="dropdown-item" href="../../articles/package_development/package_maintenance.html">Package maintenance</a></li>
    <li><a class="dropdown-item" href="../../articles/package_development/basemap_data.html">Basemap data</a></li>
    <li><a class="dropdown-item" href="../../articles/package_development/package_logo.html">tools4watlas logo</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../articles/literature/literature.html">Literature</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/allertbijleveld/tools4watlas/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Add residency patches</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/allertbijleveld/tools4watlas/blob/HEAD/vignettes/extended_workflow/add_residency_patches.Rmd" class="external-link"><code>vignettes/extended_workflow/add_residency_patches.Rmd</code></a></small>
      <div class="d-none name"><code>add_residency_patches.Rmd</code></div>
    </div>

    
    
<p>This vignette shows how to assign residency patches to WATLAS data.
Since every species has distinct behaviours, this analysis will require
species specific adjustments of parameters. However, we ignore this for
this example and provide a general workflow that can be adapted to
different species and data quality.</p>
<div class="section level2">
<h2 id="background-and-parameter-explanation">Background and parameter explanation<a class="anchor" aria-label="anchor" href="#background-and-parameter-explanation"></a>
</h2>
<p>The <code><a href="../../reference/atl_res_patch.html">atl_res_patch()</a></code> function is designed to segment
WATLAS movement data into residence patches. The main parameter is speed
(<code>max_speed</code>). With perfect data that would be the only
parameter necessary to adjust, because the speeds of flying and walking
or standing do not overlap. However, because WATLAS data have
localization error (comparable to GPS accuracy, see <a href="https://besjournals.onlinelibrary.wiley.com/doi/10.1111/2041-210X.13913" class="external-link">Beardsworth
et al. 2022</a>) and can have gaps, we need to have additional variables
for classifying these data into robust residence patches.</p>
<p>The logic of the function is to first identify proto-patches
(preliminary residence patches), which are based on subsequent
localizations with a speed smaller than <code>max_speed</code>, distance
between positions smaller than <code>lim_spat_indep</code> and the time
between positions smaller than <code>lim_time_indep</code>.
Proto-patches which have less positions than <code>min_fixes</code>, are
then filtered out.</p>
<p>Then the function calculates the median proto-patch position and the
time between proto-patch (time between last location and first location
of the next proto-patch). Based on this, proto-patches are merged if the
distance between the median position of the proto-patch is &lt;
<code>lim_spat_indep</code>, and the time between the proto-patch is
&lt; <code>lim_time_indep</code>.</p>
<p>Lastly, the function assigns a unique patch ID for each residency
patch from 1 to n, in order of the time.</p>
<p>Note: Keep in mind that smoothing and thinning will influence the
speed and thus the residence patches. The <code><a href="../../reference/atl_res_patch.html">atl_res_patch()</a></code>
function is designed to work with data that has already been filtered
(<code>var_max &lt; 5000</code>) and smoothed
(<code>moving_window = 5</code>), so it is recommended to run this
function after these steps. With short position intervals (e.g. 3 sec),
position error can lead to speed outliers, which influences
(i.e. reduces) the creation of proto-patches. To avoid this, the speed
can be set to a higher value, or the data can be thinned before.</p>
<p><strong>Parameters overview:</strong></p>
<ul>
<li>
<strong><code>max_speed</code>:</strong> A numeric value specifying
the <strong>maximum speed (m/s)</strong> between two coordinates that
would be considered non-transitory.</li>
<li>
<strong><code>lim_spat_indep</code>:</strong> A numeric value of
<strong>distance in metres of the spatial distance between two
patches</strong> for them to the considered independent. This parameter
is there to avoid that a gap in data does not make a new proto-patch
when the bird was still at the same location and works in combination
with <code>lim_time_indep</code>.</li>
<li>
<strong><code>lim_time_indep</code>:</strong> A numeric value of
time in minutes of the <strong>time difference between two patches for
them to be considered independent</strong>. This parameter can prevent
the creation new proto-patches when there are large gaps in the data.
For example, at the roost site a bird might not move for long in at a
location with bad signal strength, but we can assume the bird was still
at the same location. If the bird then moves away and sends data again,
we can classify all positions at this place as the same residency
patch.</li>
<li>
<strong><code>min_fixes</code>:</strong> The <strong>minimum number
of fixes</strong> for a group of spatially-proximate number of points to
be considered a proto-patch. To make sure that at least a few points are
considered together to qualify as residency patch.</li>
<li>
<strong><code>min_duration</code>:</strong> The <strong>minimum
duration</strong> (in seconds) for classifying residence patches. With
high-sampling interval (e.g. 1 sec), short residence patches can be
created, which are not biological relevant.</li>
</ul>
<p><strong>Guidelines to choose parameters:</strong></p>
<p>In general, when deciding on the optimal parameters, the key is to
find a good balance between true and false positives. We give some
starting points for each parameter, which has to be adjusted based on
the data quality and species behaviour.</p>
<ul>
<li>
<strong><code>max_speed</code>:</strong> Should be as high as
possible in between walking and flying speeds. Due to error in data
erroneously high/‘flying’ speeds are corrected due to subsequent
proto-patches being merged on distance. A good starting point is
<strong>3 m/s</strong>, but could be increased if needed, if it prevents
the creation of proto-patches that should be assigned as resident
locations.</li>
<li>
<strong><code>lim_spat_indep</code>:</strong> Decides on the
distance between two proto-patches to be considered independent. This is
a key parameter, because it prevents the creation of new proto-patches
when the bird is still at the same location. A good starting point is
<strong>75 m</strong>, but could be increased if the data are very gappy
or if the species has large elongated foraging patches.</li>
<li>
<strong><code>lim_time_indep</code>:</strong> <strong>180
min</strong> (3 hours) works typically, but could be increased (e.g. to
240 or higher) with really gappy data. For example, when the analysis is
focused on roosting behaviour, this could be increased to e.g. 6 hours
(360 min), to deal with large gaps in the data that can occur with
roosting birds not moving and being at the same place with bad signal
strength.</li>
<li>
<strong><code>min_fixes</code>:</strong> As small as possible. Only
assign new patch if speed is consistently (several points) below this
threshold, not just once. <strong>3 fixes</strong> should usually
work.</li>
<li>
<strong><code>min_duration</code>:</strong> As small as possible,
given biological relevance. <strong>120 sec</strong> (2 minutes) seems
reasonable.</li>
</ul>
<div class="section level3">
<h3 id="load-packages-and-required-data">Load packages and required data<a class="anchor" aria-label="anchor" href="#load-packages-and-required-data"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://allertbijleveld.github.io/tools4watlas/">tools4watlas</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach" class="external-link">foreach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://doFuture.futureverse.org" class="external-link">doFuture</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load example data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data_example</span></span>
<span></span>
<span><span class="co"># file path to WATLAS teams data folder</span></span>
<span><span class="va">fp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/atl_file_path.html">atl_file_path</a></span><span class="op">(</span><span class="st">"watlas_teams"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load tide pattern data</span></span>
<span><span class="va">tidal_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="va">fp</span>, <span class="st">"waterdata/allYears-tidalPattern-west_terschelling-UTC.csv"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="calculate-residency-patches-by-tag">Calculate residency patches by tag<a class="anchor" aria-label="anchor" href="#calculate-residency-patches-by-tag"></a>
</h2>
<p>To calculate residency patches, we can first subset relevant columns
from the data (to reduce the memory size of the table - as this table
will be sent to all cores when computing in parallel), but also can use
the original <code>data.table</code>, if working with few data. We then
extract the unique tag IDs from the data and run
<code><a href="../../reference/atl_res_patch.html">atl_res_patch()</a></code> for each tag in parallel, which adds an
additional column to the data table, called <code>patch</code>, which
contains unique patch ID’s for each tag.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># subset relevant columns</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">species</span>, <span class="va">posID</span>, <span class="va">tag</span>, <span class="va">time</span>, <span class="va">datetime</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">tideID</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># unique tag ID</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">tag</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># register cores and backend for parallel processing</span></span>
<span><span class="fu"><a href="https://doFuture.futureverse.org/reference/registerDoFuture.html" class="external-link">registerDoFuture</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># loop through all tags to calculate residency patches</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="va">id</span>, .combine <span class="op">=</span> <span class="st">"rbind"</span><span class="op">)</span> <span class="op"><a href="https://doFuture.futureverse.org/reference/grapes-dofuture-grapes.html" class="external-link">%dofuture%</a></span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../../reference/atl_res_patch.html">atl_res_patch</a></span><span class="op">(</span></span>
<span>    <span class="va">data</span><span class="op">[</span><span class="va">tag</span> <span class="op">==</span> <span class="va">i</span><span class="op">]</span>,</span>
<span>    max_speed <span class="op">=</span> <span class="fl">3</span>, lim_spat_indep <span class="op">=</span> <span class="fl">75</span>, lim_time_indep <span class="op">=</span> <span class="fl">180</span>,</span>
<span>    min_fixes <span class="op">=</span> <span class="fl">3</span>, min_duration <span class="op">=</span> <span class="fl">120</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># close parallel workers</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># show head of the summary table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="10%">
<col width="7%">
<col width="6%">
<col width="13%">
<col width="24%">
<col width="10%">
<col width="9%">
<col width="9%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th align="left">species</th>
<th align="right">posID</th>
<th align="left">tag</th>
<th align="right">time</th>
<th align="left">datetime</th>
<th align="right">x</th>
<th align="right">y</th>
<th align="right">tideID</th>
<th align="right">patch</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">redshank</td>
<td align="right">2</td>
<td align="left">3027</td>
<td align="right">1695438805</td>
<td align="left">2023-09-23 03:13:25</td>
<td align="right">650705.6</td>
<td align="right">5902556</td>
<td align="right">2023513</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">redshank</td>
<td align="right">3</td>
<td align="left">3027</td>
<td align="right">1695438808</td>
<td align="left">2023-09-23 03:13:28</td>
<td align="right">650705.6</td>
<td align="right">5902556</td>
<td align="right">2023513</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">redshank</td>
<td align="right">4</td>
<td align="left">3027</td>
<td align="right">1695439189</td>
<td align="left">2023-09-23 03:19:49</td>
<td align="right">650721.0</td>
<td align="right">5902559</td>
<td align="right">2023513</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">redshank</td>
<td align="right">5</td>
<td align="left">3027</td>
<td align="right">1695439192</td>
<td align="left">2023-09-23 03:19:52</td>
<td align="right">650721.1</td>
<td align="right">5902559</td>
<td align="right">2023513</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">redshank</td>
<td align="right">6</td>
<td align="left">3027</td>
<td align="right">1695439195</td>
<td align="left">2023-09-23 03:19:55</td>
<td align="right">650723.1</td>
<td align="right">5902564</td>
<td align="right">2023513</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">redshank</td>
<td align="right">7</td>
<td align="left">3027</td>
<td align="right">1695439198</td>
<td align="left">2023-09-23 03:19:58</td>
<td align="right">650723.1</td>
<td align="right">5902564</td>
<td align="right">2023513</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="evaluate-residency-patch-classification-and-parameters">Evaluate residency patch classification and parameters<a class="anchor" aria-label="anchor" href="#evaluate-residency-patch-classification-and-parameters"></a>
</h2>
<p>The function <code><a href="../../reference/atl_check_res_patch.html">atl_check_res_patch()</a></code> can be used to
evaluate the residency patch classification, by tag and tide. The title
of the plot gives standard information about the data and the water
level for the corresponding tide. It plots the track with residency
patches on a map and shows the duration (time in a patch in min) as
coloured polygon on the map and as plot against the time in a separate
plot. Time starts on the top and goes from high tide to high tide (solid
blue lines), as well as indicating low tide (dashed blue line).</p>
<div class="section level3">
<h3 id="example-for-one-tag-and-tide">Example for one tag and tide<a class="anchor" aria-label="anchor" href="#example-for-one-tag-and-tide"></a>
</h3>
<p>We can select one tag and tide to plot the data. Additionally, we
need to specify the offset of the tidal data we use (e.g. 30 min for
Terschelling) and a buffer (in m) around the residency patch data to
create a polygon. This buffer should best be
<code>lim_spat_indep</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/atl_check_res_patch.html">atl_check_res_patch</a></span><span class="op">(</span></span>
<span>  <span class="va">data</span><span class="op">[</span><span class="va">tag</span> <span class="op">==</span> <span class="st">"3038"</span><span class="op">]</span>, tide_data <span class="op">=</span> <span class="va">tidal_pattern</span>,</span>
<span>  tide <span class="op">=</span> <span class="st">"2023513"</span>, offset <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  buffer_res_patches <span class="op">=</span> <span class="fl">75</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="add_residency_patches_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="Overview plot res patches one tide" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="loop-through-all-tags-and-tides">Loop through all tags and tides<a class="anchor" aria-label="anchor" href="#loop-through-all-tags-and-tides"></a>
</h3>
<p>For a better overview we can also plot all data by tag and tide or
for example a random sample of 100 tags and tides. The plots are saved
in the choosen directory (e.g. <code>./outputs/res_patch_check/</code> -
edit path as desired), which has to be created before running the
code.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># unique ID combinations</span></span>
<span><span class="va">idc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"tag"</span>, <span class="st">"tideID"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sample 100 combinations to plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">idc</span> <span class="op">&lt;-</span> <span class="va">idc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">100</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># register cores and backend for parallel processing</span></span>
<span><span class="fu"><a href="https://doFuture.futureverse.org/reference/registerDoFuture.html" class="external-link">registerDoFuture</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># loop to make plots for all</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">idc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://doFuture.futureverse.org/reference/grapes-dofuture-grapes.html" class="external-link">%dofuture%</a></span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># plot and save for each combination</span></span>
<span>  <span class="fu"><a href="../../reference/atl_check_res_patch.html">atl_check_res_patch</a></span><span class="op">(</span></span>
<span>    <span class="va">data</span><span class="op">[</span><span class="va">tag</span> <span class="op">==</span> <span class="va">idc</span><span class="op">$</span><span class="va">tag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    tide_data <span class="op">=</span> <span class="va">tidal_pattern</span>,</span>
<span>    tide <span class="op">=</span> <span class="va">idc</span><span class="op">$</span><span class="va">tideID</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, offset <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    buffer_res_patches <span class="op">=</span> <span class="fl">75</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"./outputs/res_patch_check/"</span>,</span>
<span>      <span class="va">idc</span><span class="op">$</span><span class="va">species</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_tag_"</span>, <span class="va">idc</span><span class="op">$</span><span class="va">tag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_tide_"</span>, <span class="va">idc</span><span class="op">$</span><span class="va">tideID</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># close parallel workers</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>Based on these plots and potentially additional checks, the
parameters can be adjusted to improve the classification of residency
patches.</p>
</div>
</div>
<div class="section level2">
<h2 id="summary-of-residency-patch-data">Summary of residency patch data<a class="anchor" aria-label="anchor" href="#summary-of-residency-patch-data"></a>
</h2>
<p>Once we are satisfied with the residency patch classification, we can
summarize the residency patches by tag and patch and merge desired
columns back to our full data table.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># summary of residency patches</span></span>
<span><span class="va">data_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/atl_res_patch_summary.html">atl_res_patch_summary</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># duration in minutes</span></span>
<span><span class="va">data_summary</span><span class="op">[</span>, <span class="va">duration</span> <span class="op">:=</span> <span class="va">duration</span> <span class="op">/</span> <span class="fl">60</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># merge desired summary columns to data</span></span>
<span><span class="va">data</span><span class="op">[</span><span class="va">data_summary</span>, on <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tag"</span>, <span class="st">"patch"</span><span class="op">)</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  duration <span class="op">=</span> <span class="va">i.duration</span>,</span>
<span>  disp_in_patch <span class="op">=</span> <span class="va">i.disp_in_patch</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># show head of the summary table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_summary</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="2%">
<col width="3%">
<col width="3%">
<col width="4%">
<col width="4%">
<col width="4%">
<col width="4%">
<col width="4%">
<col width="4%">
<col width="4%">
<col width="4%">
<col width="5%">
<col width="6%">
<col width="5%">
<col width="5%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="7%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left">tag</th>
<th align="right">patch</th>
<th align="right">nfixes</th>
<th align="right">x_mean</th>
<th align="right">x_median</th>
<th align="right">x_start</th>
<th align="right">x_end</th>
<th align="right">y_mean</th>
<th align="right">y_median</th>
<th align="right">y_start</th>
<th align="right">y_end</th>
<th align="right">time_mean</th>
<th align="right">time_median</th>
<th align="right">time_start</th>
<th align="right">time_end</th>
<th align="right">dist_in_patch</th>
<th align="right">dist_bw_patch</th>
<th align="right">time_bw_patch</th>
<th align="right">disp_in_patch</th>
<th align="right">duration</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">3027</td>
<td align="right">1</td>
<td align="right">52</td>
<td align="right">650705.5</td>
<td align="right">650702.8</td>
<td align="right">650705.6</td>
<td align="right">650701.9</td>
<td align="right">5902566</td>
<td align="right">5902562</td>
<td align="right">5902556</td>
<td align="right">5902570</td>
<td align="right">1695439841</td>
<td align="right">1695439509</td>
<td align="right">1695438805</td>
<td align="right">1695442747</td>
<td align="right">178.36</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">14.61</td>
<td align="right">65.70</td>
</tr>
<tr class="even">
<td align="left">3027</td>
<td align="right">2</td>
<td align="right">60</td>
<td align="right">650776.6</td>
<td align="right">650776.6</td>
<td align="right">650778.7</td>
<td align="right">650771.9</td>
<td align="right">5902216</td>
<td align="right">5902217</td>
<td align="right">5902216</td>
<td align="right">5902206</td>
<td align="right">1695443135</td>
<td align="right">1695443132</td>
<td align="right">1695443041</td>
<td align="right">1695443230</td>
<td align="right">51.41</td>
<td align="right">362.21</td>
<td align="right">293.98</td>
<td align="right">12.29</td>
<td align="right">3.15</td>
</tr>
<tr class="odd">
<td align="left">3027</td>
<td align="right">3</td>
<td align="right">2456</td>
<td align="right">650760.9</td>
<td align="right">650762.0</td>
<td align="right">650778.4</td>
<td align="right">650699.8</td>
<td align="right">5901722</td>
<td align="right">5901737</td>
<td align="right">5902014</td>
<td align="right">5901490</td>
<td align="right">1695447498</td>
<td align="right">1695447344</td>
<td align="right">1695443257</td>
<td align="right">1695451884</td>
<td align="right">1968.58</td>
<td align="right">192.16</td>
<td align="right">27.00</td>
<td align="right">530.22</td>
<td align="right">143.79</td>
</tr>
<tr class="even">
<td align="left">3027</td>
<td align="right">4</td>
<td align="right">64</td>
<td align="right">648364.2</td>
<td align="right">648362.5</td>
<td align="right">648360.7</td>
<td align="right">648365.8</td>
<td align="right">5901596</td>
<td align="right">5901590</td>
<td align="right">5901578</td>
<td align="right">5901620</td>
<td align="right">1695452281</td>
<td align="right">1695452282</td>
<td align="right">1695452178</td>
<td align="right">1695452382</td>
<td align="right">79.03</td>
<td align="right">2340.88</td>
<td align="right">293.98</td>
<td align="right">42.01</td>
<td align="right">3.40</td>
</tr>
<tr class="odd">
<td align="left">3027</td>
<td align="right">5</td>
<td align="right">41</td>
<td align="right">648059.6</td>
<td align="right">648058.4</td>
<td align="right">648059.7</td>
<td align="right">648058.4</td>
<td align="right">5902193</td>
<td align="right">5902192</td>
<td align="right">5902184</td>
<td align="right">5902204</td>
<td align="right">1695452509</td>
<td align="right">1695452511</td>
<td align="right">1695452439</td>
<td align="right">1695452577</td>
<td align="right">48.94</td>
<td align="right">641.75</td>
<td align="right">57.00</td>
<td align="right">19.69</td>
<td align="right">2.30</td>
</tr>
<tr class="even">
<td align="left">3027</td>
<td align="right">6</td>
<td align="right">316</td>
<td align="right">647775.8</td>
<td align="right">647776.4</td>
<td align="right">647771.5</td>
<td align="right">647775.4</td>
<td align="right">5902555</td>
<td align="right">5902555</td>
<td align="right">5902560</td>
<td align="right">5902546</td>
<td align="right">1695453152</td>
<td align="right">1695453155</td>
<td align="right">1695452625</td>
<td align="right">1695453663</td>
<td align="right">452.32</td>
<td align="right">456.97</td>
<td align="right">48.00</td>
<td align="right">13.69</td>
<td align="right">17.30</td>
</tr>
</tbody>
</table>
<table class="table">
<colgroup>
<col width="18%">
<col width="81%">
</colgroup>
<thead><tr class="header">
<th>Column</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>tag</strong></td>
<td>4 digit tag number (character), i.e. last 4 digits of the full tag
number</td>
</tr>
<tr class="even">
<td><strong>patch</strong></td>
<td>Patch ID</td>
</tr>
<tr class="odd">
<td><strong>nfixes</strong></td>
<td>Number of fixes in the patch</td>
</tr>
<tr class="even">
<td><strong>x_mean</strong></td>
<td>Mean X-coordinate in meters (UTM 31 N)</td>
</tr>
<tr class="odd">
<td><strong>x_median</strong></td>
<td>Median X-coordinate in meters (UTM 31 N)</td>
</tr>
<tr class="even">
<td><strong>x_start</strong></td>
<td>X-coordinate at the start of the patch (UTM 31 N)</td>
</tr>
<tr class="odd">
<td><strong>x_end</strong></td>
<td>X-coordinate at the end of the patch (UTM 31 N)</td>
</tr>
<tr class="even">
<td><strong>y_mean</strong></td>
<td>Mean Y-coordinate in meters (UTM 31 N)</td>
</tr>
<tr class="odd">
<td><strong>y_median</strong></td>
<td>Median Y-coordinate in meters (UTM 31 N)</td>
</tr>
<tr class="even">
<td><strong>y_start</strong></td>
<td>Y-coordinate at the start of the patch (UTM 31 N)</td>
</tr>
<tr class="odd">
<td><strong>y_end</strong></td>
<td>Y-coordinate at the end of the patch (UTM 31 N)</td>
</tr>
<tr class="even">
<td><strong>time_mean</strong></td>
<td>Mean UNIX time (seconds) for the patch</td>
</tr>
<tr class="odd">
<td><strong>time_median</strong></td>
<td>Median UNIX time (seconds) for the patch</td>
</tr>
<tr class="even">
<td><strong>time_start</strong></td>
<td>Start UNIX time (seconds) of the patch</td>
</tr>
<tr class="odd">
<td><strong>time_end</strong></td>
<td>End UNIX time (seconds) of the patch</td>
</tr>
<tr class="even">
<td><strong>dist_in_patch</strong></td>
<td>Total distance (in meters) travelled within the patch (cummulative
distance)</td>
</tr>
<tr class="odd">
<td><strong>dist_bw_patch</strong></td>
<td>Distance (in meters) between end of previous and start of current
patch</td>
</tr>
<tr class="even">
<td><strong>time_bw_patch</strong></td>
<td>Time (in seconds) between end of previous and start of current
patch</td>
</tr>
<tr class="odd">
<td><strong>disp_in_patch</strong></td>
<td>Straight-line displacement (in meters) between start and end of the
patch</td>
</tr>
<tr class="even">
<td><strong>duration</strong></td>
<td>Time duration (in seconds) spent within the patch</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="plot-by-tag">Plot by tag<a class="anchor" aria-label="anchor" href="#plot-by-tag"></a>
</h3>
<p>We can also easily plot the residency patches by tag as desired using
<code>ggplot2</code>. In this example we will plot the residency patches
for one red knot (tag 3038). The residency patches are coloured by patch
ID, and the points are plotted with a grey colour to show the track.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># subset red knot</span></span>
<span><span class="va">data_subset</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">tag</span> <span class="op">==</span> <span class="fl">3038</span><span class="op">]</span></span>
<span><span class="va">data_summary_subset</span> <span class="op">&lt;-</span> <span class="va">data_summary</span><span class="op">[</span><span class="va">tag</span> <span class="op">==</span> <span class="fl">3038</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># create basemap</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/atl_create_bm.html">atl_create_bm</a></span><span class="op">(</span><span class="va">data_subset</span>, buffer <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># track with residency patches coloured</span></span>
<span><span class="va">bm</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_subset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_subset</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="add_residency_patches_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" alt="Residency patches within track colored by ID" width="100%"></p>
<p>Or we could plot the residency patch at it’s median position with the
duration in minutes as size and colour of the points.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot residency patches itself by duration</span></span>
<span><span class="va">bm</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_summary_subset</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x_median</span>, <span class="va">y_median</span>, color <span class="op">=</span> <span class="va">duration</span>, size <span class="op">=</span> <span class="va">duration</span><span class="op">)</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">TRUE</span>, alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="add_residency_patches_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" alt="Residency patches by duration in patch" width="100%"></p>
</div>
<div class="section level3">
<h3 id="plot-by-species">Plot by species<a class="anchor" aria-label="anchor" href="#plot-by-species"></a>
</h3>
<p>Similar, we can plot the residency patches by species. For this we
need to merge the species information back to the summary table, which
is done in the code below. The residency patches are coloured by species
and sized by duration.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create basemap</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/atl_create_bm.html">atl_create_bm</a></span><span class="op">(</span><span class="va">data</span>, buffer <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add species</span></span>
<span><span class="va">du</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span>, by <span class="op">=</span> <span class="st">"tag"</span><span class="op">)</span></span>
<span><span class="va">data_summary</span> <span class="op">&lt;-</span> <span class="va">data_summary</span><span class="op">[</span><span class="va">du</span>, on <span class="op">=</span> <span class="st">"tag"</span>, <span class="fu">`:=`</span><span class="op">(</span>species <span class="op">=</span> <span class="va">i.species</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># plot residency patches itself by duration and species</span></span>
<span><span class="va">bm</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_summary</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x_median</span>, <span class="va">y_median</span>, color <span class="op">=</span> <span class="va">species</span>, size <span class="op">=</span> <span class="va">duration</span><span class="op">)</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">TRUE</span>, alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="../../reference/atl_spec_cols.html">atl_spec_cols</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="../../reference/atl_spec_labs.html">atl_spec_labs</a></span><span class="op">(</span><span class="st">"multiline"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="add_residency_patches_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" alt="Residency patches colored by species" width="100%"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/krietsch" class="external-link">Johannes Krietsch</a>, <a href="https://www.nioz.nl/en/about/organisation/staff/allert-bijleveld" class="external-link">Allert Bijleveld</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
